<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCAR OSPINO | CRIOSER SOLUTIONS Gestión de Revisiones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #170155; /* Dark Purple */
            --secondary-color: #F5F5F5; /* Light Gray */
            --accent-color: #8A8A8A; /* Medium Gray */
            --text-color: #333333;
            --background-light: #FFFFFF;
            --border-color: #E0E0E0;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
        }

        body {
            font-family: 'Lato', sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Improved Sidebar with Animation */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar .logo {
            width: 150px;
            margin-bottom: 30px;
            transition: width 0.3s ease;
        }

        .sidebar.collapsed .logo {
            width: 40px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .sidebar ul li {
            margin-bottom: 15px;
        }

        .sidebar ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            border-radius: 5px;
        }

        .sidebar ul li a i {
            margin-right: 10px;
            min-width: 20px;
        }

        .sidebar ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .sidebar.collapsed ul li a span {
            display: none;
        }

        .sidebar-toggle {
            position: absolute;
            top: 10px;
            right: -15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            transform: rotate(180deg);
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
            box-sizing: border-box;
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 60px;
            width: calc(100% - 60px);
        }

        header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
        }

        .section {
            display: none;
            background-color: var(--background-light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.6em;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Home Section with Animated Cards */
        #homeSection .start-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .start-option {
            text-align: center;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: var(--secondary-color);
        }

        .start-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .start-option img {
            max-width: 150px;
            height: auto;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .start-option:hover img {
            transform: scale(1.1);
        }

        .start-option h3 {
            font-size: 1.2em;
            font-weight: 400;
            margin: 0;
        }

        /* Improved Forms with Animations */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 400;
            transition: color 0.3s ease;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--background-light);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(23, 1, 85, 0.2);
        }

        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .param-table th, .param-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            transition: background-color 0.3s ease;
        }

        .param-table th {
            background-color: var(--secondary-color);
            font-weight: 700;
        }

        .param-table tr:hover {
            background-color: rgba(245, 245, 245, 0.5);
        }

        .param-table input {
            width: 100%;
            padding: 8px;
            border: none;
            background: transparent;
            transition: background-color 0.3s ease;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 400;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .btn:hover {
            background-color: #0d0033;
            transform: scale(1.05);
        }

        .btn-secondary {
            background-color: var(--accent-color);
        }

        .btn-secondary:hover {
            background-color: #6F6F6F;
            transform: scale(1.05);
        }

        /* Improved Review Table with Hover Effects */
        .review-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .review-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .review-table th, .review-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            transition: background-color 0.3s ease;
        }

        .review-table th {
            background-color: var(--secondary-color);
            font-weight: 700;
        }

        .review-table tr:hover {
            background-color: var(--secondary-color);
        }

        .review-table .actions button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }

        .review-table .actions button:hover {
            transform: scale(1.1);
        }

        /* Footer */
        footer {
            margin-top: auto;
            padding: 15px;
            text-align: center;
            color: var(--accent-color);
            border-top: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        /* Custom Alert Styles */
        .custom-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 2000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .custom-alert.show {
            opacity: 1;
            transform: translateY(0);
        }

        .custom-alert.success {
            background-color: var(--success-color);
        }

        .custom-alert.error {
            background-color: var(--error-color);
        }

        .custom-alert.warning {
            background-color: var(--warning-color);
        }

        .custom-alert.info {
            background-color: var(--info-color);
        }

        /* Custom Confirm Modal */
        .custom-confirm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-width: 400px;
            text-align: center;
        }

        .custom-confirm.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .custom-confirm button {
            margin: 10px 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .custom-confirm .confirm-yes {
            background-color: var(--success-color);
            color: white;
        }

        .custom-confirm .confirm-no {
            background-color: var(--error-color);
            color: white;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        /* PDF Templates for Page Splitting */
        .pdf-template-page {
            width: 612pt; /* A4 width less margin (595pt A4 width) */
            padding: 40pt;
            box-sizing: border-box;
            background: white;
            font-family: 'Poppins', sans-serif;
            color: #333;
            display: none; /* Keep hidden until rendering */
        }

        /* Estilos del encabezado del PDF */
        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40pt;
            padding-bottom: 10pt;
            border-bottom: 2pt solid #00008B;
        }

        .pdf-header img {
            max-width: 120pt;
            height: auto;
            margin-left: 20pt;
        }

        .pdf-header-info {
            text-align: left;
            font-size: 10pt;
            line-height: 1.4;
        }

        .pdf-header-info h1 {
            color: #00008B;
            font-size: 16pt;
            margin-bottom: 5pt;
        }

        .pdf-header-info p {
            margin: 0;
        }

        /* Estilos de información del cliente y factura */
        .pdf-review-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30pt;
            border: 1pt solid #ddd;
            padding: 15pt;
            border-radius: 5pt;
            background-color: #f9f9f9;
        }

        .pdf-review-details div {
            flex: 1;
            font-size: 10pt;
            line-height: 1.5;
        }

        .pdf-review-details h3 {
            color: #00008B;
            font-size: 12pt;
            margin-bottom: 10pt;
            border-bottom: 1pt solid #eee;
            padding-bottom: 5pt;
        }

        .pdf-review-details p {
            margin: 0;
            margin-bottom: 5pt;
        }

        .pdf-review-details strong {
            color: #00008B;
        }

        /* Estilos de la tabla de ítems del PDF */
        .pdf-params-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30pt;
        }

        .pdf-params-table th, .pdf-params-table td {
            border: 1pt solid #ddd;
            padding: 10pt;
            text-align: left;
            font-size: 9pt;
        }

        .pdf-params-table th {
            background-color: #00008B;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pdf-params-table tbody tr:nth-child(even) {
            background-color: #f0f0f0;
        }

        .pdf-params-table .text-right {
            text-align: right;
        }

        .pdf-conclusion-section {
            display: flex;
            justify-content: flex-end;
            font-size: 11pt;
            font-weight: 700;
            margin-top: 20pt;
            border-top: 2pt solid #00008B;
            padding-top: 10pt;
        }

        .pdf-conclusion-section div {
            width: 100%;
        }

        .pdf-notes {
            margin-top: 30pt;
            font-size: 9pt;
            line-height: 1.5;
            padding: 10pt;
            background-color: #f9f9f9;
            border: 1pt solid #eee;
            border-radius: 5pt;
        }

        .pdf-notes h4 {
            font-size: 10pt;
            margin-bottom: 5pt;
            color: #00008B;
        }

        /* Estilos para la sección de imágenes en el PDF */
        .pdf-images-section {
            margin-top: 30pt;
            padding-top: 15pt;
            border-top: 1pt solid #eee;
        }

        .pdf-images-section h4 {
            font-size: 10pt;
            margin-bottom: 15pt;
            color: #00008B;
            text-align: center;
        }

        .pdf-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10pt;
            justify-content: center; /* Center images horizontally */
        }

        .pdf-images-container img {
            max-width: 45%; /* Adjust based on desired layout, e.g., two images per row */
            height: auto;
            border: 1pt solid #ddd;
            padding: 5pt;
            box-sizing: border-box;
            max-height: 150pt; /* Limit height to prevent images from being too large */
            object-fit: contain; /* Ensure the image fits within the bounds without cropping */
        }

        /* Estilos del pie de página del PDF */
        .pdf-footer {
            margin-top: 30pt; /* Adjusted margin to not be 'auto' as we are capturing as image */
            text-align: center;
            font-size: 8pt;
            color: #666;
            border-top: 1pt solid #eee;
            padding-top: 10pt;
        }

        @media print {
            body > *:not(.pdf-template-page) {
                display: none !important;
            }
            .pdf-template-page {
                display: block !important;
                width: 100% !important;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .sidebar .logo {
                width: 40px;
            }

            .sidebar ul li a span {
                display: none;
            }

            .main-content {
                margin-left: 60px;
                width: calc(100% - 60px);
                padding: 15px;
            }

            .start-options {
                grid-template-columns: 1fr;
            }
        }

        /* Image preview styles */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            border: 1px dashed var(--border-color);
            padding: 10px;
            border-radius: 4px;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            background-color: var(--secondary-color);
            transition: transform 0.3s ease;
        }

        .image-preview-item:hover {
            transform: scale(1.05);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .image-preview-item .remove-image-btn:hover {
            background-color: rgba(0,0,0,0.7);
        }
        
        /* Modal Style for Guía de Medición */
        .measurement-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(96, 108, 128, 0.9); /* Darker overlay */
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .measurement-modal-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 600px; /* Adjusted size */
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        
        .measurement-modal-content.show {
             transform: scale(1);
        }

    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="custom-confirm" id="customConfirm">
        <p id="confirmMessage"></p>
        <button class="confirm-yes" id="confirmYes">Sí</button>
        <button class="confirm-no" id="confirmNo">No</button>
    </div>

    <nav class="sidebar" id="sidebar">
        <img src="LOGO.png" alt="Logo" class="logo">
        <ul>
            <li><a href="#" onclick="showSection('homeSection')" class="active"><i class="fas fa-home"></i> <span>Home</span></a></li>
            <li><a href="#" onclick="showSection('createAireSection')"><i class="fas fa-plus"></i> <span>Revisión Aire</span></a></li>
            <li><a href="#" onclick="showSection('createNeveraSection')"><i class="fas fa-plus"></i> <span>Revisión Nevera</span></a></li>
            <li><a href="#" onclick="showSection('manageSection')"><i class="fas fa-list"></i> <span>Gestionar</span></a></li>
            <li><a href="#" onclick="showSection('settingsSection')"><i class="fas fa-cog"></i> <span>Ajustes</span></a></li>
        </ul>
        <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-chevron-left"></i></button>
    </nav>

    <div class="main-content" id="mainContent">
        <header>
            <h1>Gestión de Revisiones Técnicas</h1>
        </header>

        <section id="homeSection" class="section active">
            <h2>Inicio</h2>
            <div class="start-options">
                <div class="start-option" onclick="showSection('createAireSection')">
                    <img src="LogoAire.png" alt="Aire Acondicionado">
                    <h3>Iniciar Diagnóstico de Aire</h3>
                </div>
                <div class="start-option" onclick="showSection('createNeveraSection')">
                    <img src="LogoNevera.jpg" alt="Nevera">
                    <h3>Iniciar Diagnóstico de Nevera</h3>
                </div>
            </div>
        </section>

        <section id="createAireSection" class="section">
            <h2>Diagnóstico de Aire Acondicionado</h2>
            <form id="aireForm">
                <div class="form-group">
                    <label for="fecha">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>
                <div class="form-group">
                    <label for="tecnico">Técnico</label>
                    <input type="text" id="tecnico" name="tecnico" required>
                </div>
                <div class="form-group">
                    <label for="cliente">Cliente</label>
                    <input type="text" id="cliente" name="cliente" required>
                </div>
                <div class="form-group">
                    <label for="direccion">Dirección</label>
                    <input type="text" id="direccion" name="direccion" required>
                </div>
                <div class="form-group">
                    <label for="telefono">Teléfono (General)</label>
                    <input type="text" id="telefono" name="telefono" required>
                </div>
                <div class="form-group">
                    <label for="telefonoCliente">Teléfono Cliente (WhatsApp)</label>
                    <input type="tel" id="telefonoCliente" name="telefonoCliente" placeholder="Ej: 573101234567" required>
                </div>
                <div class="form-group">
                    <label for="marca">Marca</label>
                    <input type="text" id="marca" name="marca" required>
                </div>
                <div class="form-group">
                    <label for="modelo">Modelo</label>
                    <input type="text" id="modelo" name="modelo" required>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo</label>
                    <input type="text" id="tipo" name="tipo" required>
                </div>
                <div class="form-group">
                    <label for="capacidad">Capacidad</label>
                    <input type="text" id="capacidad" name="capacidad" required>
                </div>

                <h3>Parámetros Eléctricos <button type="button" class="btn-secondary btn-sm" id="openGuideBtnAir" style="font-size: 0.8em;"><i class="fas fa-book"></i> Guía de Medición</button></h3>
                <table class="param-table" id="aireElectricos">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>Valor Medido</th>
                            <th>Valor Normal</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Voltaje de alimentación (V)</td>
                            <td><input type="text" name="voltajeMedido"></td>
                            <td>110V / 220V ±10%</td>
                            <td><input type="text" name="voltajeObs"></td>
                        </tr>
                        <tr>
                            <td>Corriente total (A)</td>
                            <td><input type="text" name="corrienteTotalMedido"></td>
                            <td>Según placa técnica</td>
                            <td><input type="text" name="corrienteTotalObs"></td>
                        </tr>
                        <tr>
                            <td>Corriente del compresor (A)</td>
                            <td><input type="text" name="compresorMedido"></td>
                            <td>±10% del nominal</td>
                            <td><input type="text" name="compresorObs"></td>
                        </tr>
                        <tr>
                            <td>Corriente del ventilador exterior (A)</td>
                            <td><input type="text" name="ventExteriorMedido"></td>
                            <td>0.3–1.5 A aprox.</td>
                            <td><input type="text" name="ventExteriorObs"></td>
                        </tr>
                        <tr>
                            <td>Corriente del ventilador interior (A)</td>
                            <td><input type="text" name="ventInteriorMedido"></td>
                            <td>0.2–1 A aprox.</td>
                            <td><input type="text" name="ventInteriorObs"></td>
                        </tr>
                    </tbody>
                </table>

                <h3>Parámetros de Refrigeración</h3>
                <table class="param-table" id="aireRefrigeracion">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>Valor Medido</th>
                            <th>Rango Normal</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Presión de succión (PSI)</td>
                            <td><input type="text" name="succPsiMedido"></td>
                            <td>60–80 (R410A) / 45–65 (R22)</td>
                            <td><input type="text" name="succPsiObs"></td>
                        </tr>
                        <tr>
                            <td>Presión de descarga (PSI)</td>
                            <td><input type="text" name="descPsiMedido"></td>
                            <td>280–320 (R410A) / 200–250 (R22)</td>
                            <td><input type="text" name="descPsiObs"></td>
                        </tr>
                        <tr>
                            <td>Temperatura de succión (°C)</td>
                            <td><input type="text" name="succTempMedido"></td>
                            <td>5–10°C (aprox.)</td>
                            <td><input type="text" name="succTempObs"></td>
                        </tr>
                        <tr>
                            <td>Temperatura de descarga (°C)</td>
                            <td><input type="text" name="descTempMedido"></td>
                            <td>65–90°C (aprox.)</td>
                            <td><input type="text" name="descTempObs"></td>
                        </tr>
                        <tr>
                            <td>Supercalentamiento (SH) (°C)</td>
                            <td><input type="text" name="shMedido"></td>
                            <td>4–7°C</td>
                            <td><input type="text" name="shObs"></td>
                        </tr>
                        <tr>
                            <td>Subenfriamiento (SC) (°C)</td>
                            <td><input type="text" name="scMedido"></td>
                            <td>3–6°C</td>
                            <td><input type="text" name="scObs"></td>
                        </tr>
                        <tr>
                            <td>∆T (Temp. Entrada-Salida) (°C)</td>
                            <td><input type="text" name="deltaTMedido"></td>
                            <td>8–12°C</td>
                            <td><input type="text" name="deltaTObs"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-group">
                    <label for="conclusion">Conclusión y Recomendaciones</label>
                    <textarea id="conclusion" name="conclusion" rows="5"></textarea>
                </div>

                <div class="form-group">
                    <label for="imageUpload">Adjuntar Imágenes (Max 5)</label>
                    <input type="file" id="imageUpload" name="imageUpload" accept="image/*" multiple onchange="handleImageUpload(event, 'imagePreviewsContainer', selectedImages)">
                    <div class="image-preview-container" id="imagePreviewsContainer">
                        </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetFormAire()"><i class="fas fa-eraser"></i> Limpiar</button>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Revisión</button>
                    <button type="button" class="btn" style="background-color: var(--info-color);" onclick="generatePDF('aire')"><i class="fas fa-file-pdf"></i> Generar PDF y Enviar</button>
                </div>
            </form>
        </section>

        <section id="createNeveraSection" class="section">
            <h2>Diagnóstico de Nevera/Refrigerador</h2>
            <form id="neveraForm">
                <div class="form-group">
                    <label for="fechaNevera">Fecha</label>
                    <input type="date" id="fechaNevera" name="fecha" required>
                </div>
                <div class="form-group">
                    <label for="tecnicoNevera">Técnico</label>
                    <input type="text" id="tecnicoNevera" name="tecnico" required>
                </div>
                <div class="form-group">
                    <label for="clienteNevera">Cliente</label>
                    <input type="text" id="clienteNevera" name="cliente" required>
                </div>
                <div class="form-group">
                    <label for="direccionNevera">Dirección</label>
                    <input type="text" id="direccionNevera" name="direccion" required>
                </div>
                <div class="form-group">
                    <label for="telefonoNevera">Teléfono (General)</label>
                    <input type="text" id="telefonoNevera" name="telefono" required>
                </div>
                <div class="form-group">
                    <label for="telefonoClienteNevera">Teléfono Cliente (WhatsApp)</label>
                    <input type="tel" id="telefonoClienteNevera" name="telefonoCliente" placeholder="Ej: 573101234567" required>
                </div>
                <div class="form-group">
                    <label for="marcaNevera">Marca</label>
                    <input type="text" id="marcaNevera" name="marca" required>
                </div>
                <div class="form-group">
                    <label for="modeloNevera">Modelo</label>
                    <input type="text" id="modeloNevera" name="modelo" required>
                </div>
                <div class="form-group">
                    <label for="tipoNevera">Tipo</label>
                    <input type="text" id="tipoNevera" name="tipo" required>
                </div>
                <div class="form-group">
                    <label for="capacidadNevera">Capacidad</label>
                    <input type="text" id="capacidadNevera" name="capacidad" required>
                </div>

                <h3>Parámetros Eléctricos <button type="button" class="btn-secondary btn-sm" id="openGuideBtnFridge" style="font-size: 0.8em;"><i class="fas fa-book"></i> Guía de Medición</button></h3>
                <table class="param-table" id="neveraElectricos">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>Valor Medido</th>
                            <th>Valor Normal</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Voltaje (V)</td>
                            <td><input type="text" name="voltajeMedido"></td>
                            <td>110V ±10%</td>
                            <td><input type="text" name="voltajeObs"></td>
                        </tr>
                        <tr>
                            <td>Corriente total (A)</td>
                            <td><input type="text" name="corrienteTotalMedido"></td>
                            <td>Según placa</td>
                            <td><input type="text" name="corrienteTotalObs"></td>
                        </tr>
                        <tr>
                            <td>Corriente del compresor (A)</td>
                            <td><input type="text" name="compresorMedido"></td>
                            <td>±10% del nominal</td>
                            <td><input type="text" name="compresorObs"></td>
                        </tr>
                        <tr>
                            <td>Continuidad de tierra</td>
                            <td><input type="text" name="continuidadMedido"></td>
                            <td>Debe existir</td>
                            <td><input type="text" name="continuidadObs"></td>
                        </tr>
                        <tr>
                            <td>Relé/PTC</td>
                            <td><input type="text" name="releMedido"></td>
                            <td>Correcto</td>
                            <td><input type="text" name="releObs"></td>
                        </tr>
                    </tbody>
                </table>

                <h3>Parámetros de Refrigeración</h3>
                <table class="param-table" id="neveraRefrigeracion">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>Valor Medido</th>
                            <th>Rango Normal</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Presión de succión (PSI)</td>
                            <td><input type="text" name="succPsiMedido"></td>
                            <td>0–5 (R600a) / 5–10 (R134a)</td>
                            <td><input type="text" name="succPsiObs"></td>
                        </tr>
                        <tr>
                            <td>Presión de descarga (PSI)</td>
                            <td><input type="text" name="descPsiMedido"></td>
                            <td>120–150 (R600a) / 150–180 (R134a)</td>
                            <td><input type="text" name="descPsiObs"></td>
                        </tr>
                        <tr>
                            <td>Temp. evaporador (°C)</td>
                            <td><input type="text" name="evapTempMedido"></td>
                            <td>-18°C a -25°C</td>
                            <td><input type="text" name="evapTempObs"></td>
                        </tr>
                        <tr>
                            <td>Temp. congelador (°C)</td>
                            <td><input type="text" name="congeladorTempMedido"></td>
                            <td>-18°C a 0°C</td>
                            <td><input type="text" name="congeladorTempObs"></td>
                        </tr>
                        <tr>
                            <td>Temp. conservador (°C)</td>
                            <td><input type="text" name="conservadorTempMedido"></td>
                            <td>2°C a 5°C</td>
                            <td><input type="text" name="conservadorTempObs"></td>
                        </tr>
                        <tr>
                            <td>Supercalentamiento (SH) (°C)</td>
                            <td><input type="text" name="shMedido"></td>
                            <td>4–7°C</td>
                            <td><input type="text" name="shObs"></td>
                        </tr>
                        <tr>
                            <td>Subenfriamiento (SC) (°C)</td>
                            <td><input type="text" name="scMedido"></td>
                            <td>3–6°C</td>
                            <td><input type="text" name="scObs"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-group">
                    <label for="conclusionNevera">Conclusión y Recomendaciones</label>
                    <textarea id="conclusionNevera" name="conclusion" rows="5"></textarea>
                </div>

                <div class="form-group">
                    <label for="imageUploadNevera">Adjuntar Imágenes (Max 5)</label>
                    <input type="file" id="imageUploadNevera" name="imageUpload" accept="image/*" multiple onchange="handleImageUpload(event, 'imagePreviewsContainerNevera', document.getElementById('neveraForm').imagesBase64)">
                    <div class="image-preview-container" id="imagePreviewsContainerNevera">
                        </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetFormNevera()"><i class="fas fa-eraser"></i> Limpiar</button>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Revisión</button>
                    <button type="button" class="btn" style="background-color: var(--info-color);" onclick="generatePDF('nevera')"><i class="fas fa-file-pdf"></i> Generar PDF y Enviar</button>
                </div>
            </form>
        </section>

        <section id="manageSection" class="section">
            <h2>Gestionar Documentos</h2>
            <div class="form-group">
                <input type="text" id="search" onkeyup="filterReviews()" placeholder="Buscar por cliente, marca o técnico...">
            </div>
            <div class="review-table-container">
                <table class="review-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Técnico</th>
                            <th>Equipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTableBody">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="settingsSection" class="section">
            <h2>Ajustes de la Empresa</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label for="companyName">Nombre de la Empresa</label>
                    <input type="text" id="companyName" name="companyName" required>
                </div>
                <div class="form-group">
                    <label for="companyAddress">Dirección</label>
                    <input type="text" id="companyAddress" name="companyAddress">
                </div>
                <div class="form-group">
                    <label for="companyPhone">Teléfono</label>
                    <input type="text" id="companyPhone" name="companyPhone">
                </div>
                <div class="form-group">
                    <label for="companyEmail">Email</label>
                    <input type="email" id="companyEmail" name="companyEmail">
                </div>
                <div class="form-group">
                    <label for="companyNIT">Código Empresarial / NIT</label>
                    <input type="text" id="companyNIT" name="companyNIT">
                </div>
                <div class="form-group">
                    <label for="logoUpload">Logo de la Empresa</label>
                    <input type="file" id="logoUpload" name="logoUpload" accept="image/*" onchange="handleLogoUpload(event)">
                    <div id="logoPreview" style="margin-top: 10px;">
                        </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Ajustes</button>
                </div>
            </form>

            <h2 style="margin-top: 40px;">Gestión de Datos</h2>
            <div class="button-group" style="justify-content: flex-start;">
                <button type="button" class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> Exportar Datos</button>
                <button type="button" class="btn" style="background-color: var(--error-color);" onclick="confirmAction('¿Está seguro de que desea eliminar TODAS las revisiones guardadas? Esta acción es irreversible.', clearAllData)"><i class="fas fa-trash"></i> Eliminar Todas</button>
            </div>
        </section>

        <footer>
            &copy; <span id="currentYear"></span> OSCAR OSPINO | CRIOSER SOLUTIONS. Todos los derechos reservados.
        </footer>
    </div>

    <div id="pdfTemplatesContainer" style="position: absolute; left: -9999px;">
        <div id="pdfTemplateAirePage1" class="pdf-template-page">
            <div class="pdf-header">
                <div class="pdf-header-info">
                    <h1 id="pdfHeaderCompanyNameAire">OSCAR OSPINO | CRIOSER SOLUTIONS</h1>
                    <p id="pdfCompanyAddressAire">Dirección de la Empresa</p>
                    <p id="pdfCompanyPhoneAire">Teléfono: (XXX) XXX-XXXX</p>
                    <p id="pdfCompanyEmailAire">Email: tu_correo@empresa.com</p>
                    <p id="pdfCompanyNITAire">Código Empresarial: XXX.XXX.XXX-X</p>
                </div>
                <img id="pdfCompanyLogoAire" src="" alt="Logo">
            </div>
            <div class="pdf-review-details">
                <div>
                    <h3>Información del Cliente</h3>
                    <p><strong>Cliente:</strong> <span id="pdfClienteAire"></span></p>
                    <p><strong>Dirección:</strong> <span id="pdfDireccionAire"></span></p>
                    <p><strong>Teléfono:</strong> <span id="pdfTelefonoAire"></span></p>
                    <p><strong>Teléfono (WhatsApp):</strong> <span id="pdfTelefonoClienteAire"></span></p>
                </div>
                <div>
                    <h3>Información de la Revisión</h3>
                    <p><strong>Fecha:</strong> <span id="pdfFechaAire"></span></p>
                    <p><strong>Técnico:</strong> <span id="pdfTecnicoAire"></span></p>
                    <p><strong>Marca:</strong> <span id="pdfMarcaAire"></span></p>
                    <p><strong>Modelo:</strong> <span id="pdfModeloAire"></span></p>
                    <p><strong>Tipo:</strong> <span id="pdfTipoAire"></span></p>
                    <p><strong>Capacidad:</strong> <span id="pdfCapacidadAire"></span></p>
                </div>
            </div>
            <h3>Parámetros Eléctricos</h3>
            <table id="pdfElectricosAire" class="pdf-params-table">
                <thead>
                    <tr>
                        <th>Parámetro</th>
                        <th>Valor Medido</th>
                        <th>Valor Normal</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="pdfTemplateAirePage2" class="pdf-template-page">
            <div class="pdf-header" style="opacity: 0;"></div> <h3>Parámetros de Refrigeración</h3>
            <table id="pdfRefrigeracionAire" class="pdf-params-table">
                <thead>
                    <tr>
                        <th>Parámetro</th>
                        <th>Valor Medido</th>
                        <th>Rango Normal</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <h3>Conclusión y Recomendaciones</h3>
            <div class="pdf-notes" id="pdfConclusionAire"></div>

            <div class="pdf-images-section">
                <h4>Imágenes de la Revisión</h4>
                <div class="pdf-images-container" id="pdfImagesAire">
                    </div>
            </div>

            <div class="pdf-footer">
                Documento generado digitalmente por CRIOSER SOLUTIONS. Consulte la versión original para validación.
            </div>
        </div>

        <div id="pdfTemplateNeveraPage1" class="pdf-template-page">
            <div class="pdf-header">
                <div class="pdf-header-info">
                    <h1 id="pdfHeaderCompanyNameNevera">OSCAR OSPINO | CRIOSER SOLUTIONS</h1>
                    <p id="pdfCompanyAddressNevera">Dirección de la Empresa</p>
                    <p id="pdfCompanyPhoneNevera">Teléfono: (XXX) XXX-XXXX</p>
                    <p id="pdfCompanyEmailNevera">Email: tu_correo@empresa.com</p>
                    <p id="pdfCompanyNITNevera">Código Empresarial: XXX.XXX.XXX-X</p>
                </div>
                <img id="pdfCompanyLogoNevera" src="" alt="Logo">
            </div>
            <div class="pdf-review-details">
                <div>
                    <h3>Información del Cliente</h3>
                    <p><strong>Cliente:</strong> <span id="pdfClienteNevera"></span></p>
                    <p><strong>Dirección:</strong> <span id="pdfDireccionNevera"></span></p>
                    <p><strong>Teléfono:</strong> <span id="pdfTelefonoNevera"></span></p>
                    <p><strong>Teléfono (WhatsApp):</strong> <span id="pdfTelefonoClienteNevera"></span></p>
                </div>
                <div>
                    <h3>Información de la Revisión</h3>
                    <p><strong>Fecha:</strong> <span id="pdfFechaNevera"></span></p>
                    <p><strong>Técnico:</strong> <span id="pdfTecnicoNevera"></span></p>
                    <p><strong>Marca:</strong> <span id="pdfMarcaNevera"></span></p>
                    <p><strong>Modelo:</strong> <span id="pdfModeloNevera"></span></p>
                    <p><strong>Tipo:</strong> <span id="pdfTipoNevera"></span></p>
                    <p><strong>Capacidad:</strong> <span id="pdfCapacidadNevera"></span></p>
                </div>
            </div>
            <h3>Parámetros Eléctricos</h3>
            <table id="pdfElectricosNevera" class="pdf-params-table">
                <thead>
                    <tr>
                        <th>Parámetro</th>
                        <th>Valor Medido</th>
                        <th>Valor Normal</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="pdfTemplateNeveraPage2" class="pdf-template-page">
            <div class="pdf-header" style="opacity: 0;"></div> <h3>Parámetros de Refrigeración</h3>
            <table id="pdfRefrigeracionNevera" class="pdf-params-table">
                <thead>
                    <tr>
                        <th>Parámetro</th>
                        <th>Valor Medido</th>
                        <th>Rango Normal</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <h3>Conclusión y Recomendaciones</h3>
            <div class="pdf-notes" id="pdfConclusionNevera"></div>

            <div class="pdf-images-section">
                <h4>Imágenes de la Revisión</h4>
                <div class="pdf-images-container" id="pdfImagesNevera">
                    </div>
            </div>

            <div class="pdf-footer">
                Documento generado digitalmente por CRIOSER SOLUTIONS. Consulte la versión original para validación.
            </div>
        </div>
    </div>

    <div id="guideModal" class="measurement-modal">
        <div class="measurement-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 0;">
                <h3 style="color: var(--primary-color); margin: 0;"><i class="fas fa-book-open"></i> Guía de Medición Rápida</h3>
                <button id="closeGuideModal" style="font-size: 2rem; border: none; background: none; cursor: pointer; color: var(--accent-color);">&times;</button>
            </div>
            
            <div style="line-height: 1.6; color: var(--text-color); padding: 0 20px 20px;">
                
                <h3 style="color: var(--primary-color); font-size: 1.3em; margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;"><i class="fas fa-bolt"></i> Parámetros Eléctricos (Pinza Voltiamperimétrica)</h3>
                
                <h4 style="font-size: 1.1em; color: #00008B; margin-top: 15px;">1. Voltaje de alimentación (V)</h4>
                <ul style="list-style: disc; margin-left: 25px;">
                    <li><strong>Herramienta:</strong> Pinza Voltiamperimétrica (Función Voltímetro).</li>
                    <li><strong>Ubicación:</strong> Bornes de entrada de energía del equipo.</li>
                    <li><strong>Procedimiento:</strong> Conecte las puntas de prueba en <strong>paralelo</strong> (Línea-Neutro o L1-L2). Mida <strong>mientras el equipo opera</strong> (bajo carga).</li>
                    <li><strong>Precisión:</strong> El valor debe ser <strong>estable</strong> y encontrarse dentro del <strong>+/-10%</strong> del voltaje nominal.</li>
                </ul>

                <h4 style="font-size: 1.1em; color: #00008B; margin-top: 15px;">2. Corriente (Total, Compresor, Ventiladores) (A)</h4>
                <ul style="list-style: disc; margin-left: 25px;">
                    <li><strong>Herramienta:</strong> Pinza Voltiamperimétrica (Función Amperímetro).</li>
                    <li><strong>Ubicación:</strong> Cables individuales de cada componente.</li>
                    <li><strong>Procedimiento:</strong> Coloque la pinza <strong>alrededor de un solo conductor (Fase)</strong> del componente a medir. Mida la corriente <strong>después de 10-15 minutos</strong> de operación (régimen estable).</li>
                    <li><strong>Precisión:</strong> El valor del compresor debe ser igual o ligeramente inferior al RLA (Rated Load Amps) de la placa. La corriente total es la suma vectorial de todos los componentes.</li>
                </ul>

                <h3 style="color: var(--primary-color); font-size: 1.3em; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;"><i class="fas fa-temperature-three-quarters"></i> Parámetros de Refrigeración y Temperatura</h3>

                <h4 style="font-size: 1.1em; color: #00008B; margin-top: 15px;">3. Presión de Succión y Descarga (PSI)</h4>
                <ul style="list-style: disc; margin-left: 25px;">
                    <li><strong>Herramienta:</strong> Manómetro Calibrado (o Manifold).</li>
                    <li><strong>Ubicación:</strong> Puerto de servicio de baja (succión) y alta (descarga).</li>
                    <li><strong>Procedimiento:</strong> Conecte el manómetro con el equipo apagado para purgar mangueras y luego encienda el equipo. Mida la presión <strong>una vez que el compresor estabilice</strong> la temperatura del gas.</li>
                    <li><strong>Precisión:</strong> La presión de succión es crítica; debe ser <strong>traducida a temperatura de evaporación</strong> usando la <strong>Tabla P/T</strong> del refrigerante.</li>
                </ul>

                <h4 style="font-size: 1.1em; color: #00008B; margin-top: 15px;">4. Temperatura de Succión y Descarga de Tubería (°C)</h4>
                <ul style="list-style: disc; margin-left: 25px;">
                    <li><strong>Herramienta:</strong> Termómetro de Contacto Digital (Sonda con pinza).</li>
                    <li><strong>Ubicación:</strong> Tubería de succión (cerca del compresor) y tubería de descarga (salida del compresor).</li>
                    <li><strong>Procedimiento:</strong> Fije la pinza de contacto firmemente a la tubería y, si es posible, <strong>aísle la sonda</strong> para que no mida la temperatura ambiente.</li>
                    <li><strong>Precisión:</strong> Esta medición se usa para calcular el <strong>Supercalentamiento</strong> (Temp Succión - Temp Saturación P/T) y el <strong>Subenfriamiento</strong> (Temp Saturación P/T - Temp Líquido).</li>
                </ul>
                
                <h4 style="font-size: 1.1em; color: #00008B; margin-top: 15px;">5. ∆T (Diferencia de Temperatura Entrada-Salida de Aire)</h4>
                <ul style="list-style: disc; margin-left: 25px;">
                    <li><strong>Herramienta:</strong> Termómetro de Contacto Digital (Medición ambiental/punta de sonda).</li>
                    <li><strong>Ubicación:</strong> <ul>
                            <li><strong>T1 (Entrada):</strong> Centro de la rejilla de retorno (o filtro de aire).</li>
                            <li><strong>T2 (Salida):</strong> Centro de la rejilla de suministro (difusor de aire frío).</li>
                        </ul>
                    </li>
                    <li><strong>Procedimiento:</strong> Mida la temperatura del aire en ambos puntos con el equipo en régimen de enfriamiento. Reste $\text{T}1 - \text{T}2$.</li>
                    <li><strong>Precisión:</strong> El resultado debe estar idealmente entre <strong>8–12°C</strong> (Con una tolerancia de +/- 1°C). Un valor fuera de este rango sugiere problemas de flujo de aire o de refrigeración.</li>
                </ul>

            </div>
            <div style="text-align: right; border-top: 1px solid var(--border-color); padding: 15px 20px;">
                <button id="closeGuideModalFooter" class="btn btn-secondary"> Cerrar Guía </button>
            </div>
        </div>
    </div>
    
    <script>
        let reviews = [];
        let settings = {};
        let selectedImages = [];
        let currentEditingId = null;
        let currentType = null;
        const MAX_IMAGES = 5;
        let sidebarCollapsed = false;

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.sidebar ul li a[onclick*="${sectionId}"]`).classList.add('active');
            // Reset forms when switching to create sections
            if (sectionId === 'createAireSection') {
                resetFormAire();
            } else if (sectionId === 'createNeveraSection') {
                resetFormNevera();
            }
        }

        // --- Data Handling ---
        function saveData() {
            localStorage.setItem('reviews', JSON.stringify(reviews));
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function loadData() {
            const storedReviews = localStorage.getItem('reviews');
            const storedSettings = localStorage.getItem('settings');
            if (storedReviews) {
                reviews = JSON.parse(storedReviews);
            }
            if (storedSettings) {
                settings = JSON.parse(storedSettings);
                document.getElementById('companyName').value = settings.companyName || '';
                document.getElementById('companyAddress').value = settings.companyAddress || '';
                document.getElementById('companyPhone').value = settings.companyPhone || '';
                document.getElementById('companyEmail').value = settings.companyEmail || '';
                document.getElementById('companyNIT').value = settings.companyNIT || '';
            }
        }

        function clearAllData() {
            reviews = [];
            localStorage.removeItem('reviews');
            renderReviews();
            showAlert('Todas las revisiones han sido eliminadas.', 'success');
        }

        function exportData() {
            const dataStr = JSON.stringify({ reviews: reviews, settings: settings }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `criosersolutions_data_export_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showAlert('Datos exportados exitosamente.', 'success');
        }

        // --- Alert and Confirm Functions ---
        function showAlert(message, type = 'info') {
            const alertBox = document.createElement('div');
            alertBox.className = `custom-alert ${type}`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.classList.add('show');
            }, 10); // Start animation shortly after creation

            setTimeout(() => {
                alertBox.classList.remove('show');
                setTimeout(() => alertBox.remove(), 500); // Remove after fade-out
            }, 4000);
        }

        function confirmAction(message, callback) {
            const confirmBox = document.getElementById('customConfirm');
            const overlay = document.getElementById('overlay');
            document.getElementById('confirmMessage').textContent = message;
            
            overlay.classList.add('show');
            confirmBox.classList.add('show');

            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            const cleanup = () => {
                confirmYes.onclick = null;
                confirmNo.onclick = null;
                overlay.classList.remove('show');
                confirmBox.classList.remove('show');
            };

            confirmYes.onclick = () => {
                cleanup();
                callback();
            };

            confirmNo.onclick = () => {
                cleanup();
            };
        }
        
        // --- Form Submission and Data Retrieval ---
        function getTableData(tableId) {
            const table = document.getElementById(tableId);
            const data = [];
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const param = row.querySelector('td:first-child').textContent.trim();
                const medidoInput = row.querySelector('input[name*="Medido"]');
                const obsInput = row.querySelector('input[name*="Obs"]');
                const normalValue = row.querySelector('td:nth-child(3)').textContent.trim();

                data.push({
                    param: param,
                    medido: medidoInput ? medidoInput.value : '',
                    normal: normalValue,
                    obs: obsInput ? obsInput.value : ''
                });
            });
            return data;
        }

        function processFormSubmission(type, form) {
            const formInputs = form.querySelectorAll('input, textarea');
            let reviewData = {};
            
            // Get basic info
            formInputs.forEach(input => {
                if (input.name && !input.name.includes('Medido') && !input.name.includes('Obs') && !input.type.includes('file')) {
                    reviewData[input.name] = input.value;
                }
            });

            reviewData.id = currentEditingId || Date.now();
            reviewData.type = type;
            reviewData.imagesBase64 = type === 'aire' ? selectedImages : document.getElementById('neveraForm').imagesBase64; // Retrieve images for the specific form
            
            // Electricos and Refrigeracion
            const electricos = getTableData(type === 'aire' ? 'aireElectricos' : 'neveraElectricos');
            const refrigeracion = getTableData(type === 'aire' ? 'aireRefrigeracion' : 'neveraRefrigeracion');

            reviewData.electrico = electricos;
            reviewData.refrigeracion = refrigeracion;
            reviewData.conclusion = form.querySelector('textarea[name="conclusion"]').value;
            
            if (currentEditingId) {
                const index = reviews.findIndex(r => r.id === currentEditingId);
                if (index !== -1) {
                    reviews[index] = reviewData;
                    showAlert('Revisión actualizada exitosamente.', 'info');
                }
                currentEditingId = null;
            } else {
                reviews.push(reviewData);
                showAlert('Revisión guardada exitosamente.');
            }
            
            saveData();
            renderReviews();
            document.querySelector('#createAireSection h2').textContent = 'Diagnóstico de Aire Acondicionado';
            document.querySelector('#createNeveraSection h2').textContent = 'Diagnóstico de Nevera';
        }

        document.getElementById('aireForm').addEventListener('submit', function(event) {
            event.preventDefault();
            processFormSubmission('aire', event.target);
        });

        document.getElementById('neveraForm').addEventListener('submit', function(event) {
            event.preventDefault();
            processFormSubmission('nevera', event.target);
        });


        function resetFormAire() {
            document.getElementById('aireForm').reset();
            currentEditingId = null;
            selectedImages = [];
            document.getElementById('imagePreviewsContainer').innerHTML = '';
            document.querySelector('#createAireSection h2').textContent = 'Diagnóstico de Aire Acondicionado';
            document.getElementById('fecha').valueAsDate = new Date(); // Reset date
        }

        function resetFormNevera() {
            document.getElementById('neveraForm').reset();
            currentEditingId = null;
            document.getElementById('neveraForm').imagesBase64 = [];
            document.getElementById('imagePreviewsContainerNevera').innerHTML = '';
            document.querySelector('#createNeveraSection h2').textContent = 'Diagnóstico de Nevera';
            document.getElementById('fechaNevera').valueAsDate = new Date(); // Reset date
        }

        function editReview(id, type) {
            const review = reviews.find(r => r.id === id);
            if (!review) return;
            currentEditingId = id;
            showSection(type === 'aire' ? 'createAireSection' : 'createNeveraSection');
            
            const form = document.getElementById(type === 'aire' ? 'aireForm' : 'neveraForm');
            form.querySelector(`h2`).textContent = `Editando Revisión de ${type === 'aire' ? 'Aire' : 'Nevera'} (ID: ${id})`;

            // Fill General Info
            form.querySelector('input[name="fecha"]').value = review.fecha;
            form.querySelector('input[name="tecnico"]').value = review.tecnico;
            form.querySelector('input[name="cliente"]').value = review.cliente;
            form.querySelector('input[name="direccion"]').value = review.direccion;
            form.querySelector('input[name="telefono"]').value = review.telefono;
            form.querySelector('input[name="telefonoCliente"]').value = review.telefonoCliente || '';
            form.querySelector('input[name="marca"]').value = review.marca;
            form.querySelector('input[name="modelo"]').value = review.modelo;
            form.querySelector('input[name="tipo"]').value = review.tipo;
            form.querySelector('input[name="capacidad"]').value = review.capacidad;
            form.querySelector('textarea[name="conclusion"]').value = review.conclusion;

            // Fill Tables (Electricos and Refrigeracion)
            const electricosTable = document.getElementById(type === 'aire' ? 'aireElectricos' : 'neveraElectricos');
            const refrigeracionTable = document.getElementById(type === 'aire' ? 'aireRefrigeracion' : 'neveraRefrigeracion');

            // Helper to fill table data
            const fillTable = (table, reviewData) => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    if (reviewData[index]) {
                        row.querySelector('input[name*="Medido"]').value = reviewData[index].medido;
                        row.querySelector('input[name*="Obs"]').value = reviewData[index].obs;
                    }
                });
            };

            fillTable(electricosTable, review.electrico);
            fillTable(refrigeracionTable, review.refrigeracion);

            // Fill Images
            const imageList = review.imagesBase64 || [];
            const container = document.getElementById(type === 'aire' ? 'imagePreviewsContainer' : 'imagePreviewsContainerNevera');
            container.innerHTML = '';
            if (type === 'aire') {
                selectedImages = imageList.slice();
            } else {
                document.getElementById('neveraForm').imagesBase64 = imageList.slice();
            }

            imageList.forEach((base64, index) => {
                const item = createImagePreviewItem(base64, container.id, imageList);
                container.appendChild(item);
            });
        }

        function deleteReview(id) {
            confirmAction('¿Está seguro de que desea eliminar esta revisión?', () => {
                const initialLength = reviews.length;
                reviews = reviews.filter(r => r.id !== id);
                if (reviews.length < initialLength) {
                    saveData();
                    renderReviews();
                    showAlert('Revisión eliminada exitosamente.', 'success');
                }
            });
        }

        function renderReviews() {
            const tableBody = document.getElementById('reviewsTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            reviews.sort((a, b) => b.id - a.id); // Sort by newest first

            reviews.forEach(review => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${review.id.toString().slice(-4)}</td>
                    <td>${review.type === 'aire' ? 'Aire Acondicionado' : 'Nevera'}</td>
                    <td>${review.fecha}</td>
                    <td>${review.cliente}</td>
                    <td>${review.tecnico}</td>
                    <td>${review.marca} / ${review.modelo}</td>
                    <td class="actions">
                        <button class="btn" style="background-color: var(--info-color);" onclick="editReview(${review.id}, '${review.type}')"><i class="fas fa-edit"></i></button>
                        <button class="btn" onclick="generatePDF('${review.type}', ${review.id})"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn" style="background-color: var(--error-color);" onclick="deleteReview(${review.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }

        function filterReviews() {
            const filter = document.getElementById('search').value.toUpperCase();
            const rows = document.getElementById('reviewsTableBody').querySelectorAll('tr');
            
            rows.forEach(row => {
                const textContent = row.textContent.toUpperCase();
                if (textContent.indexOf(filter) > -1) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        // --- PDF Generation Logic ---
        function fillPdfTemplates(templateType, reviewData) {
            const prefix = templateType === 'aire' ? 'Aire' : 'Nevera';
            const tableElectricos = document.getElementById(`pdfElectricos${prefix}`).querySelector('tbody');
            const tableRefrigeracion = document.getElementById(`pdfRefrigeracion${prefix}`).querySelector('tbody');
            const pdfImagesContainer = document.getElementById(`pdfImages${prefix}`);
            const conclusionElement = document.getElementById(`pdfConclusion${prefix}`);

            // 1. General Company Info (Va en Página 1)
            document.getElementById(`pdfHeaderCompanyName${prefix}`).textContent = settings.companyName || 'OSCAR OSPINO | CRIOSER SOLUTIONS';
            document.getElementById(`pdfCompanyAddress${prefix}`).textContent = settings.companyAddress || 'N/A';
            document.getElementById(`pdfCompanyPhone${prefix}`).textContent = `Teléfono: ${settings.companyPhone || 'N/A'}`;
            document.getElementById(`pdfCompanyEmail${prefix}`).textContent = `Email: ${settings.companyEmail || 'N/A'}`;
            document.getElementById(`pdfCompanyNITAire`).textContent = `Código Empresarial: ${settings.companyNIT || 'N/A'}`;
            document.getElementById(`pdfCompanyNITNevera`).textContent = `Código Empresarial: ${settings.companyNIT || 'N/A'}`;
            
            const logoElement = document.getElementById(`pdfCompanyLogo${prefix}`);
            if (settings.companyLogoBase64) {
                logoElement.src = settings.companyLogoBase64;
                logoElement.style.display = 'block';
            } else {
                logoElement.src = '';
                logoElement.style.display = 'none';
            }


            // 2. Review Details (Va en Página 1)
            document.getElementById(`pdfCliente${prefix}`).textContent = reviewData.cliente;
            document.getElementById(`pdfDireccion${prefix}`).textContent = reviewData.direccion;
            document.getElementById(`pdfTelefono${prefix}`).textContent = reviewData.telefono;
            document.getElementById(`pdfTelefonoCliente${prefix}`).textContent = reviewData.telefonoCliente;
            document.getElementById(`pdfFecha${prefix}`).textContent = reviewData.fecha;
            document.getElementById(`pdfTecnico${prefix}`).textContent = reviewData.tecnico;
            document.getElementById(`pdfMarca${prefix}`).textContent = reviewData.marca;
            document.getElementById(`pdfModelo${prefix}`).textContent = reviewData.modelo;
            document.getElementById(`pdfTipo${prefix}`).textContent = reviewData.tipo;
            document.getElementById(`pdfCapacidad${prefix}`).textContent = reviewData.capacidad;

            // 3. Electricos Table (Va en Página 1)
            tableElectricos.innerHTML = '';
            reviewData.electrico.forEach(data => {
                const row = tableElectricos.insertRow();
                row.innerHTML = `
                    <td>${data.param}</td>
                    <td>${data.medido}</td>
                    <td>${data.normal}</td>
                    <td>${data.obs}</td>
                `;
            });

            // 4. Refrigeracion Table (Va en Página 2)
            tableRefrigeracion.innerHTML = '';
            reviewData.refrigeracion.forEach(data => {
                const row = tableRefrigeracion.insertRow();
                row.innerHTML = `
                    <td>${data.param}</td>
                    <td>${data.medido}</td>
                    <td>${data.normal}</td>
                    <td>${data.obs}</td>
                `;
            });

            // 5. Conclusion (Va en Página 2)
            conclusionElement.textContent = reviewData.conclusion || 'Sin observaciones/conclusiones adicionales registradas.';

            // 6. Images (Va en Página 2)
            pdfImagesContainer.innerHTML = '';
            if (reviewData.imagesBase64 && reviewData.imagesBase64.length > 0) {
                reviewData.imagesBase64.forEach(base64 => {
                    const img = document.createElement('img');
                    img.src = base64;
                    pdfImagesContainer.appendChild(img);
                });
            } else {
                pdfImagesContainer.innerHTML = '<p style="text-align: center; color: #888;">No se adjuntaron imágenes para esta revisión.</p>';
            }
        }

        // --- PDF Generation Logic (CORREGIDA para descarga y WhatsApp) ---
        async function generatePDF(type, id = null) {
            const contentId = type === 'aire' ? 'aireForm' : 'neveraForm';
            let reviewData;
            let filename;

            if (id !== null) {
                reviewData = reviews.find(r => r.id === id);
            } else {
                const form = document.getElementById(contentId);
                // Si no hay ID, tomamos los datos actuales del formulario
                reviewData = {
                    id: Date.now(),
                    type: type,
                    fecha: form.querySelector('input[name="fecha"]').value,
                    tecnico: form.querySelector('input[name="tecnico"]').value,
                    cliente: form.querySelector('input[name="cliente"]').value,
                    direccion: form.querySelector('input[name="direccion"]').value,
                    telefono: form.querySelector('input[name="telefono"]').value,
                    telefonoCliente: form.querySelector('input[name="telefonoCliente"]').value, // Nuevo campo de teléfono para WhatsApp
                    marca: form.querySelector('input[name="marca"]').value,
                    modelo: form.querySelector('input[name="modelo"]').value,
                    tipo: form.querySelector('input[name="tipo"]').value,
                    capacidad: form.querySelector('input[name="capacidad"]').value,
                    electrico: getTableData(type === 'aire' ? 'aireElectricos' : 'neveraElectricos'),
                    refrigeracion: getTableData(type === 'aire' ? 'aireRefrigeracion' : 'neveraRefrigeracion'),
                    conclusion: form.querySelector('textarea[name="conclusion"]').value,
                    imagesBase64: type === 'aire' ? selectedImages.slice() : document.getElementById('neveraForm').imagesBase64.slice()
                };
            }

            if (!reviewData || !reviewData.cliente || !reviewData.tecnico) {
                showAlert('Por favor, complete los campos obligatorios antes de generar el PDF.', 'error');
                return;
            }

            if (!settings.companyLogoBase64 && !confirmAction('Advertencia: El logo de la empresa no está configurado. ¿Desea continuar sin él?', () => {})) {
                return;
            }

            filename = `Revision_${type === 'aire' ? 'Aire' : 'Nevera'}_${reviewData.cliente.replace(/ /g, '_')}_${reviewData.fecha}.pdf`;

            // Llenar ambas plantillas de página
            fillPdfTemplates(type, reviewData);

            const prefix = type === 'aire' ? 'Aire' : 'Nevera';
            const pdfTemplatePage1 = document.getElementById(`pdfTemplate${prefix}Page1`);
            const pdfTemplatePage2 = document.getElementById(`pdfTemplate${prefix}Page2`);
            
            // Determinar si se necesita la página 2
            const page2Required = reviewData.refrigeracion.some(row => row.medido || row.obs) || reviewData.conclusion || (reviewData.imagesBase64 && reviewData.imagesBase64.length > 0);

            // Hacer visibles las páginas necesarias para la captura
            pdfTemplatePage1.style.display = 'block';
            if (page2Required) {
                pdfTemplatePage2.style.display = 'block';
            } else {
                pdfTemplatePage2.style.display = 'none';
            }


            try {
                const jsPDF = window.jspdf.jsPDF;
                const doc = new jsPDF('p', 'pt', 'a4'); // 'pt' is points, 595.28 x 841.89 A4
                const a4Width = 595.28;

                // Capturar la primera página
                let imgHeightPage1;
                await html2canvas(pdfTemplatePage1, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    imgHeightPage1 = (canvas.height * a4Width) / canvas.width;
                    doc.addImage(imgData, 'JPEG', 0, 0, a4Width, imgHeightPage1);
                });

                // Capturar la segunda página (si aplica)
                if (page2Required) {
                    doc.addPage();
                    let imgHeightPage2;
                    await html2canvas(pdfTemplatePage2, { scale: 2 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        imgHeightPage2 = (canvas.height * a4Width) / canvas.width;
                        doc.addImage(imgData, 'JPEG', 0, 0, a4Width, imgHeightPage2);
                    });
                }
                
                // ************************************************
                // MODIFICACIÓN 1: FORZAR DESCARGA DEL PDF
                // ************************************************
                doc.save(filename); 
                // ************************************************


                // ************************************************
                // MODIFICACIÓN 2: ENVIAR MENSAJE A WHATSAPP
                // ************************************************
                const telefonoCliente = reviewData.telefonoCliente.replace(/\D/g, ''); // Limpiar el número, solo dígitos
                if (telefonoCliente && telefonoCliente.length >= 10) { // Asumir mínimo 10 dígitos para ser válido (ej. 57310xxxxxxx)
                    
                    showAlert('PDF generado y descargado exitosamente. Abriendo chat de WhatsApp...', 'success');

                    const nombreCliente = reviewData.cliente.split(' ')[0];
                    const tipoEquipo = type === 'aire' ? 'Aire Acondicionado' : 'Nevera';
                    const numRevision = reviewData.id.toString().slice(-4); // Usar los últimos 4 dígitos del ID como "número de revisión"

                    const message = `¡Hola ${nombreCliente}! 👋 Le adjuntamos su revisión técnica. Los detalles son:\n\n*Revisión No.* ${numRevision}\n*Equipo:* ${tipoEquipo}\n*Marca:* ${reviewData.marca}\n*Modelo:* ${reviewData.modelo}\n*Realizada el:* ${reviewData.fecha}\n*Técnico:* ${reviewData.tecnico}\n\nEl reporte completo se ha descargado. Gracias por preferir CRIOSER SOLUTIONS.`;
                    
                    // Usar wa.me para la API oficial de WhatsApp
                    const whatsappUrl = `https://wa.me/${telefonoCliente}?text=${encodeURIComponent(message)}`;

                    // Abrir el enlace de WhatsApp en una nueva pestaña
                    window.open(whatsappUrl, '_blank');
                } else {
                    showAlert('Advertencia: PDF descargado, pero no se pudo abrir el enlace de WhatsApp. El teléfono del cliente (WhatsApp) no es válido o está vacío.', 'warning');
                }
                // ************************************************
                
            } catch (error) {
                console.error('Error al generar el PDF:', error);
                showAlert(`Error al generar el PDF. Revise la consola para detalles. (${error.message})`, 'error');
            } finally {
                // Ocultar ambas plantillas al finalizar
                pdfTemplatePage1.style.display = 'none';
                pdfTemplatePage2.style.display = 'none';
            }
        }
        // --- FIN FUNCIÓN GENERACIÓN PDF ---

        // --- Image Handling Logic ---
        function createImagePreviewItem(base64, containerId, imageList) {
            const item = document.createElement('div');
            item.className = 'image-preview-item';
            item.innerHTML = `<img src="${base64}" alt="Preview">
                              <button type="button" class="remove-image-btn" data-base64="${base64}">&times;</button>`;
            
            item.querySelector('.remove-image-btn').addEventListener('click', (e) => {
                const index = imageList.indexOf(base64);
                if (index > -1) {
                    imageList.splice(index, 1);
                    e.target.closest('.image-preview-item').remove();
                    showAlert('Imagen eliminada.');
                }
            });
            return item;
        }

        function handleImageUpload(event, containerId, imageList) {
            const files = event.target.files;
            const container = document.getElementById(containerId);
            const filesToProcess = Array.from(files).slice(0, MAX_IMAGES - imageList.length);

            if (imageList.length >= MAX_IMAGES) {
                showAlert(`Solo se permiten ${MAX_IMAGES} imágenes por revisión.`, 'warning');
                event.target.value = ''; // Clear file input
                return;
            }

            filesToProcess.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (imageList.length < MAX_IMAGES) {
                        const base64 = e.target.result;
                        imageList.push(base64);
                        const item = createImagePreviewItem(base64, containerId, imageList);
                        container.appendChild(item);
                        showAlert('Imagen cargada.');
                    } else {
                        showAlert(`Límite de ${MAX_IMAGES} imágenes alcanzado.`, 'warning');
                    }
                };
                reader.readAsDataURL(file);
            });
            event.target.value = ''; // Clear file input for next time
        }

        // --- Settings Logic ---
        document.getElementById('settingsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const form = event.target;
            settings.companyName = form.companyName.value;
            settings.companyAddress = form.companyAddress.value;
            settings.companyPhone = form.companyPhone.value;
            settings.companyEmail = form.companyEmail.value;
            settings.companyNIT = form.companyNIT.value;
            saveData();
            showAlert('Ajustes guardados exitosamente.', 'success');
        });

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                settings.companyLogoBase64 = e.target.result;
                document.getElementById('logoPreview').innerHTML = `<img src="${settings.companyLogoBase64}" alt="Logo Preview" style="max-width: 150px;">`;
                saveData();
                showAlert('Logo cargado exitosamente.');
            };
            reader.readAsDataURL(file);
        }

        // --- Sidebar Toggle ---
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            sidebarCollapsed = !sidebarCollapsed;
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleIcon = document.getElementById('sidebarToggle').querySelector('i');
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                toggleIcon.classList.replace('fa-chevron-left', 'fa-chevron-right');
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                toggleIcon.classList.replace('fa-chevron-right', 'fa-chevron-left');
            }
        });

        // --- Guía de Medición Modal Logic ---
        const guideModal = document.getElementById('guideModal');
        const openGuideBtnAir = document.getElementById('openGuideBtnAir');
        const openGuideBtnFridge = document.getElementById('openGuideBtnFridge');
        const closeGuideModal = document.getElementById('closeGuideModal');
        const closeGuideModalFooter = document.getElementById('closeGuideModalFooter');

        const openGuideModal = () => {
            guideModal.style.display = 'flex';
            setTimeout(() => guideModal.querySelector('.measurement-modal-content').classList.add('show'), 10);
        };

        const closeGuideModalFunc = () => {
            guideModal.querySelector('.measurement-modal-content').classList.remove('show');
            setTimeout(() => guideModal.style.display = 'none', 300);
        }

        if (openGuideBtnAir) {
            openGuideBtnAir.addEventListener('click', openGuideModal);
        }
        if (openGuideBtnFridge) {
            openGuideBtnFridge.addEventListener('click', openGuideModal);
        }

        if (closeGuideModal) {
            closeGuideModal.addEventListener('click', closeGuideModalFunc);
        }
        if (closeGuideModalFooter) {
            closeGuideModalFooter.addEventListener('click', closeGuideModalFunc);
        }
        window.addEventListener('click', (event) => {
            if (event.target === guideModal) {
                closeGuideModalFunc();
            }
        });
        // FIN MODIFICACIÓN 2

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderReviews();
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('fechaNevera').valueAsDate = new Date();
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            if (settings.companyLogoBase64) {
                document.getElementById('logoPreview').innerHTML = `<img src="${settings.companyLogoBase64}" alt="Logo Preview" style="max-width: 150px;">`;
            }
        });
    </script>
</body>
</html>